# Claude Code Remote Webview 확장 요구사항

## 1. 목적
- 기존 Claude-Code-Remote 기능을 참고해, 원격 제어/알림 기반 시스템에 **웹뷰 UI**와 **작업 태스크 보드**를 추가한다.
- 최종 목표는 인터넷에서 접속 가능한 대시보드를 통해 **에이전트 상태/작업 이력/태스크 분배**를 최소 기능으로 확인·운영하는 것이다.
- 클론한 `Claude-Code-Remote` 레포의 기능은 **전부 포함**되어야 한다. (회귀 금지)

## 2. 범위 (MVP 기준)
- Coordinator(API 서버)는 **Go**로 구현한다.
- 저장소는 **Supabase(Postgres)** 를 사용한다. (로컬 파일은 중앙 저장소로 사용하지 않음)
- 로그인/인증은 **후순위**로 미룬다. (초기에는 임시 키/토큰 방식 가능)
- 에이전트 수: 최대 10개
- 동시 접속 사용자: 최대 1,000명
- 로그/이벤트 보관: **30일**

## 3. 용어/구성요소
- **Coordinator**: 인터넷에 배포되는 Go 기반 API 서버. 에이전트 상태/이력/태스크를 중앙에서 관리한다.
- **Agent**: 로컬에서 Claude Code 세션을 관찰/제어하는 실행 프로세스. (tmux/pty 주입, 로그 수집, 채널 알림 등)
- **Channel(태스크 채널)**: 태스크를 발행/구독하는 논리적 작업 영역(예: `backend-domain`, `notify`).
- **Task**: 채널에 발행되는 작업 단위. 에이전트가 FIFO로 가져가 수행한다.
- **Event(작업 이력)**: 에이전트가 “지금까지 한 일”을 나타내는 레코드. (task_id는 NULL 가능)

## 4. 핵심 기능 요구사항

### 4.1 기존 기능 유지 (필수)
클론한 `Claude-Code-Remote` 레포에 포함된 기능은 모두 유지되어야 한다.
- 이메일 알림 + IMAP 리스너/응답
- 텔레그램 봇 + 버튼/커맨드
- LINE 메시징
- 데스크톱 알림/사운드
- tmux/pty 주입
- 실행 로그 캡처(터미널 트레이스)
- 세션 토큰/화이트리스트 보안
- CLI/스크립트 기반 테스트 & 진단

### 4.2 웹뷰 대시보드 (배포형)
- 인터넷에서 접근 가능한 웹 UI 제공
- 현재 활성 에이전트 수 표시
- 에이전트별 상태 및 현재 작업 표시
- 에이전트별 작업 이력(타임라인) 표시

### 4.3 작업 태스크 보드 (Jira 유사, 최소 기능)
- 채널(도메인) 단위로 태스크 발행
- 채널별 태스크 목록/상태 표시
- 태스크 상태 최소 단계: `Queued / In Progress / Done`

### 4.4 태스크 분배 모델
- 분배 방식: **FIFO**
- 에이전트는 채널을 구독하고, FIFO 순서대로 태스크를 가져감
- 수동 할당 가능 (자동 분배는 보조)
- FIFO claim은 **원자적(atomic)** 으로 수행되어 중복 할당이 발생하지 않아야 함

### 4.5 작업 이력 정의
- 태스크를 수행한 경우: 태스크 수행 로그를 작업 이력으로 기록
- 태스크 미할당 상태에서 실행된 명령: **사용자 명령 자체가 작업 이력**

### 4.6 웹뷰/에이전트 통신
- 로컬 에이전트는 실행 로그/상태를 Coordinator API로 전송
- 웹뷰는 실시간 상태 변화를 수신해 반영 (SSE/WS 또는 Supabase Realtime)
- 이벤트 중복 업로드를 방지하기 위한 최소한의 **idempotency** 가 필요 (구현 상세는 설계에서 결정)

## 5. 비기능 요구사항
- **경량 인프라** 지향 (최소 비용)
- 실시간성: 웹뷰에서 상태 변화가 빠르게 반영될 것
- 안정성: 에이전트/서버 재시작 시 상태 복구 가능
- 확장성: 동접 1,000명 UI 조회를 감당할 수 있어야 함 (캐시/실시간 방식은 구현에서 결정)

## 6. 데이터 모델 (초안)

### 6.1 Agents
- `id`
- `name`
- `status` (idle/running/waiting 등)
- `current_task_id`
- `last_seen`

### 6.2 Channels
- `id`
- `name`
- `description`

### 6.3 Tasks
- `id`
- `channel_id`
- `title`
- `description`
- `status`
- `priority`
- `assigned_agent_id`
- `created_at`
- `claimed_at`

### 6.4 Events (작업 이력)
- `id`
- `agent_id`
- `task_id` (NULL 가능)
- `type`
- `payload`
- `created_at`

## 7. 처리 흐름 (요약)
1) 에이전트는 상태 및 로그를 Coordinator API에 전송
2) Coordinator는 Supabase에 저장
3) 웹 UI는 실시간으로 상태/태스크/이력을 표시
4) 태스크는 채널 구독 에이전트가 FIFO로 claim

## 8. 개발 계획 (권장 순서)
요구사항 문서의 나열 순서와 실제 개발 순서는 다를 수 있다. 구현 리스크/의존성 기준으로 아래 순서를 권장한다.
1) 기존 레포 기능 스모크 테스트/회귀 테스트 기준 확보 (기능 유지 보장용)
2) Supabase 스키마/인덱스 확정 + 30일 보관 정책(정리 작업) 결정
3) Coordinator(Go) 최소 API 구현: agent heartbeat, events ingest, channels, tasks CRUD, FIFO claim
4) 로컬 에이전트에서 Coordinator로 상태/이력 업로드 연결 (기존 알림/주입 기능 유지)
5) 웹뷰 최소 UI 구현: 에이전트 리스트/상태, 채널별 태스크, 에이전트 작업 이력
6) 하드닝: 임시 인증(공유 키), rate limit, 관측성(logging/metrics), 장애/재시도 정책

## 9. 보류/추후 결정 사항
- 로그인/인증 체계(정식)
- 구체적 UI 프레임워크 및 배포 스택
- 상세 태스크 분배 정책(재시도, 실패 처리, 우선순위 규칙)
- 실행 로그(터미널 트레이스) 저장 방식: DB 직접 저장 vs 파일/오브젝트 스토리지(요금/용량 고려)
